<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSU Islam Group - Digital Signage</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
        }
    </style>
</head>
<body>
    <div id="slideshowContainer" class="slideshow-container active">
        <div class="hospital-badge">
            <div>
                <h1>RSU Islam Group</h1>
                <p>Ramah, Amanah, Profesional, Islami (RAPI)</p>
            </div>
        </div>
        
        <div id="slidesWrapper"></div>
        <div id="paginationDots" class="pagination-dots"></div>
    </div>

    <script>
        const slideshowPlayer = {
            currentSlideIndex: 0,
            currentSlideshowIndex: 0,  // NEW: Track current slideshow
            slideshowInterval: null,
            slides: [],
            slideshows: [],  // NEW: Store slideshow info
            settings: {
                slideshowTiming: 5,
                siteLogo: null,
                hospitalName: 'RSU Islam Group',
                hospitalTagline: 'Ramah, Amanah, Profesional, Islami (RAPI)',
                // NEW: Advanced display settings
                roundedImageEdges: true,
                coloredBlurBackground: true,
                titleFontSize: 40,
                subtitleFontSize: 20,
                showPaginationDots: true,
                showHospitalBadge: true
            },

            async init() {
                await this.loadSettings();
                await this.loadSlides();
                this.startAutoPlay();
                
                setInterval(async () => {
                    await this.loadSettings();
                    await this.loadSlides();
                }, 300000);
            },

            async loadSettings() {
                try {
                    // Try to load from database first
                    const response = await fetch('/api/settings');
                    const data = await response.json();
                    
                    if (data.success && data.settings) {
                        // Map database keys to camelCase
                        this.settings = {
                            slideshowTiming: data.settings.slideshow_timing || 5,
                            siteLogo: data.settings.site_logo || null,
                            hospitalName: data.settings.hospital_name || 'RSU Islam Group',
                            hospitalTagline: data.settings.hospital_tagline || 'Ramah, Amanah, Profesional, Islami (RAPI)',
                            roundedImageEdges: data.settings.rounded_image_edges !== false,
                            coloredBlurBackground: data.settings.colored_blur_background !== false,
                            titleFontSize: data.settings.title_font_size || 40,
                            subtitleFontSize: data.settings.subtitle_font_size || 20,
                            showPaginationDots: data.settings.show_pagination_dots !== false,
                            showHospitalBadge: data.settings.show_hospital_badge !== false
                        };
                    } else {
                        // Fallback to localStorage
                        const storedSettings = localStorage.getItem('rsu_settings');
                        if (storedSettings) {
                            this.settings = JSON.parse(storedSettings);
                        }
                    }
                    
                    this.applySettings();
                } catch (error) {
                    console.error('Settings load error:', error);
                    // Fallback to localStorage on error
                    try {
                        const storedSettings = localStorage.getItem('rsu_settings');
                        if (storedSettings) {
                            this.settings = JSON.parse(storedSettings);
                        }
                        this.applySettings();
                    } catch (e) {
                        console.error('localStorage fallback error:', e);
                    }
                }
            },

            applySettings() {
                const badge = document.querySelector('.hospital-badge');
                const paginationDots = document.getElementById('paginationDots');
                
                // Apply hospital badge visibility
                if (badge) {
                    badge.style.display = this.settings.showHospitalBadge !== false ? 'flex' : 'none';
                    badge.innerHTML = `
                        ${this.settings.siteLogo ? `<img src="${this.settings.siteLogo}" alt="Logo" style="width: 50px; height: 50px; object-fit: contain; flex-shrink: 0;">` : ''}
                        <div>
                            <h1>${this.settings.hospitalName}</h1>
                            <p>${this.settings.hospitalTagline}</p>
                        </div>
                    `;
                }
                
                // Apply pagination dots visibility
                if (paginationDots) {
                    paginationDots.style.display = this.settings.showPaginationDots !== false ? 'flex' : 'none';
                }
                
                // Apply dynamic CSS for advanced settings
                let styleEl = document.getElementById('dynamic-settings-style');
                if (!styleEl) {
                    styleEl = document.createElement('style');
                    styleEl.id = 'dynamic-settings-style';
                    document.head.appendChild(styleEl);
                }
                
                const titleSize = this.settings.titleFontSize || 40;
                const subtitleSize = this.settings.subtitleFontSize || 20;
                const roundedEdges = this.settings.roundedImageEdges !== false;
                const coloredBackground = this.settings.coloredBlurBackground !== false;
                
                styleEl.textContent = `
                    .slide-caption h2 {
                        font-size: ${titleSize}px !important;
                    }
                    .slide-caption p {
                        font-size: ${subtitleSize}px !important;
                    }
                    .slide img,
                    .slide-image {
                        border-radius: ${roundedEdges ? '20px' : '0'} !important;
                    }
                    .slide-background {
                        filter: blur(40px) brightness(0.7) ${!coloredBackground ? 'grayscale(100%)' : ''} !important;
                    }
                `;
                
                // Apply favicon
                if (this.settings.siteLogo) {
                    let favicon = document.querySelector('link[rel="icon"]');
                    if (!favicon) {
                        favicon = document.createElement('link');
                        favicon.rel = 'icon';
                        document.head.appendChild(favicon);
                    }
                    favicon.href = this.settings.siteLogo;
                }
            },

            async loadSlides() {
                try {
                    const response = await fetch('/api/slideshows/active');
                    const data = await response.json();
                    
                    if (data.success && data.slideshows.length > 0) {
                        // Store slideshow info for pagination
                        this.slideshows = data.slideshows.map(s => ({
                            id: s.id,
                            title: s.title,
                            description: s.description,
                            imageCount: s.images.length
                        }));
                        
                        // Flatten all images with slideshow metadata
                        this.slides = data.slideshows.flatMap(s => 
                            s.images.map(img => ({ 
                                ...img, 
                                slideshowTitle: s.title,
                                slideshowDescription: s.description || s.title,
                                slideshowId: s.id 
                            }))
                        );
                        
                        this.renderSlides();
                        
                        const uniqueIds = [...new Set(this.slides.map(s => s.slideshowId))];
                        uniqueIds.forEach(id => {
                            fetch(`/api/slideshows/${id}/display`, { method: 'POST' })
                                .catch(err => console.error('Display count error:', err));
                        });
                    } else {
                        this.loadSlidesFromLocalStorage();
                    }
                } catch (error) {
                    console.error('Load slides error:', error);
                    this.loadSlidesFromLocalStorage();
                }
            },

            loadSlidesFromLocalStorage() {
                const storedSlideshows = localStorage.getItem('rsu_slideshows');
                if (storedSlideshows) {
                    const slideshows = JSON.parse(storedSlideshows);
                    const activeSlideshows = slideshows.filter(s => s.status === 'active');
                    
                    // Store slideshow info
                    this.slideshows = activeSlideshows.map(s => ({
                        id: s.id,
                        title: s.title,
                        description: s.description,
                        imageCount: s.images.length
                    }));
                    
                    // Flatten images
                    this.slides = activeSlideshows.flatMap(s => 
                        s.images.map(img => ({ 
                            ...img, 
                            slideshowTitle: s.title, 
                            slideshowDescription: s.description || s.title,
                            slideshowId: s.id 
                        }))
                    );
                    
                    this.renderSlides();
                }
            },

            renderSlides() {
                const wrapper = document.getElementById('slidesWrapper');
                const paginationDots = document.getElementById('paginationDots');
                
                if (this.slides.length === 0) {
                    wrapper.innerHTML = `
                        <div class="slide active" style="display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; text-align: center; padding: 2rem;">
                            <div>
                                <h2>No Active Slideshows</h2>
                                <p style="font-size: 1.2rem; margin-top: 1rem;">Create slideshows in admin panel</p>
                            </div>
                        </div>
                    `;
                    paginationDots.innerHTML = '';
                    return;
                }

                // Render all slides with blurred background
                wrapper.innerHTML = this.slides.map((slide, index) => `
                    <div class="slide ${index === 0 ? 'active' : ''}">
                        <div class="slide-background" style="background-image: url('${slide.url}')"></div>
                        <img src="${slide.url}" 
                             onerror="this.onerror=null; this.src='/assets/images/placeholder.jpg'"
                             alt="${slide.slideshowTitle}"
                             class="slide-image">
                        <div class="slide-caption">
                            <h2>${slide.slideshowTitle}</h2>
                            <p>${slide.slideshowDescription}</p>
                        </div>
                    </div>
                `).join('');
                
                // NEW: Create pagination dots per slideshow (not per image!)
                paginationDots.innerHTML = this.slideshows.map((slideshow, index) => 
                    `<div class="dot ${index === 0 ? 'active' : ''}" title="${slideshow.title}"></div>`
                ).join('');
            },

            startAutoPlay() {
                if (this.slideshowInterval) {
                    clearInterval(this.slideshowInterval);
                }

                const storedSettings = localStorage.getItem('rsu_settings');
                const settings = storedSettings ? JSON.parse(storedSettings) : { slideshowTiming: 5 };
                const timing = (settings.slideshowTiming || 5) * 1000;
                
                this.slideshowInterval = setInterval(() => {
                    if (this.slides.length > 0) {
                        const slideElements = document.querySelectorAll('.slide');
                        const dotElements = document.querySelectorAll('.pagination-dots .dot');
                        
                        if (slideElements.length > 0) {
                            // Hide current slide
                            slideElements[this.currentSlideIndex]?.classList.remove('active');
                            
                            // Advance to next slide
                            this.currentSlideIndex = (this.currentSlideIndex + 1) % this.slides.length;
                            
                            // Show next slide
                            slideElements[this.currentSlideIndex]?.classList.add('active');
                            
                            // NEW: Update slideshow pagination dot
                            // Determine which slideshow the current slide belongs to
                            const currentSlide = this.slides[this.currentSlideIndex];
                            const currentSlideshowIndex = this.slideshows.findIndex(s => s.id === currentSlide.slideshowId);
                            
                            if (currentSlideshowIndex !== this.currentSlideshowIndex) {
                                // Changed slideshow, update pagination
                                dotElements[this.currentSlideshowIndex]?.classList.remove('active');
                                dotElements[currentSlideshowIndex]?.classList.add('active');
                                this.currentSlideshowIndex = currentSlideshowIndex;
                            }
                        }
                    }
                }, timing);
            }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            await slideshowPlayer.init();
            
            document.addEventListener('click', () => {
                const container = document.getElementById('slideshowContainer');
                if (container.requestFullscreen) {
                    container.requestFullscreen().catch(err => console.log('Fullscreen:', err));
                } else if (container.webkitRequestFullscreen) {
                    container.webkitRequestFullscreen();
                }
            }, { once: true });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (e.key === 'ArrowRight') {
                    const slideElements = document.querySelectorAll('.slide');
                    const dotElements = document.querySelectorAll('.pagination-dots .dot');
                    
                    slideElements[slideshowPlayer.currentSlideIndex]?.classList.remove('active');
                    
                    slideshowPlayer.currentSlideIndex = (slideshowPlayer.currentSlideIndex + 1) % slideshowPlayer.slides.length;
                    
                    slideElements[slideshowPlayer.currentSlideIndex]?.classList.add('active');
                    
                    // Update slideshow pagination
                    const currentSlide = slideshowPlayer.slides[slideshowPlayer.currentSlideIndex];
                    const newSlideshowIndex = slideshowPlayer.slideshows.findIndex(s => s.id === currentSlide.slideshowId);
                    if (newSlideshowIndex !== slideshowPlayer.currentSlideshowIndex) {
                        dotElements[slideshowPlayer.currentSlideshowIndex]?.classList.remove('active');
                        dotElements[newSlideshowIndex]?.classList.add('active');
                        slideshowPlayer.currentSlideshowIndex = newSlideshowIndex;
                    }
                } else if (e.key === 'ArrowLeft') {
                    const slideElements = document.querySelectorAll('.slide');
                    const dotElements = document.querySelectorAll('.pagination-dots .dot');
                    
                    slideElements[slideshowPlayer.currentSlideIndex]?.classList.remove('active');
                    
                    slideshowPlayer.currentSlideIndex = (slideshowPlayer.currentSlideIndex - 1 + slideshowPlayer.slides.length) % slideshowPlayer.slides.length;
                    
                    slideElements[slideshowPlayer.currentSlideIndex]?.classList.add('active');
                    
                    // Update slideshow pagination
                    const currentSlide = slideshowPlayer.slides[slideshowPlayer.currentSlideIndex];
                    const newSlideshowIndex = slideshowPlayer.slideshows.findIndex(s => s.id === currentSlide.slideshowId);
                    if (newSlideshowIndex !== slideshowPlayer.currentSlideshowIndex) {
                        dotElements[slideshowPlayer.currentSlideshowIndex]?.classList.remove('active');
                        dotElements[newSlideshowIndex]?.classList.add('active');
                        slideshowPlayer.currentSlideshowIndex = newSlideshowIndex;
                    }
                }
            });
        });
    </script>
</body>
</html>
