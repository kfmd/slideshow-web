/* Slideshow Display JavaScript */

let slideshows = [];
let allSlides = [];
let currentSlideIndex = 0;
let slideshowInterval = null;
let settings = {
  font_family: 'Arial, sans-serif',
  title_font_size: '48',
  description_font_size: '24',
  transition_duration: '5000',
  company_logo: ''
};

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
  await loadSettings();
  await loadSlideshows();
  initializeSlideshow();
  setupEventListeners();
  requestFullscreen();
});

// Load settings
async function loadSettings() {
  try {
    const response = await fetch('/api/settings');
    if (response.ok) {
      settings = await response.json();
      applySettings();
    }
  } catch (error) {
    console.error('Failed to load settings:', error);
  }
}

function applySettings() {
  // Apply font settings
  document.documentElement.style.setProperty('--font-family', settings.font_family);
  document.documentElement.style.setProperty('--title-font-size', settings.title_font_size + 'px');
  document.documentElement.style.setProperty('--description-font-size', settings.description_font_size + 'px');
  
  // Apply company logo
  if (settings.company_logo) {
    const logoEl = document.getElementById('companyLogo');
    logoEl.src = settings.company_logo;
    logoEl.style.display = 'block';
  }
}

// Load slideshows
async function loadSlideshows() {
  try {
    const urlParams = new URLSearchParams(window.location.search);
    const slideshowId = urlParams.get('id');
    
    if (slideshowId) {
      // Load specific slideshow
      const response = await fetch(`/api/slideshows/${slideshowId}`);
      if (response.ok) {
        const slideshow = await response.json();
        slideshows = [slideshow];
        allSlides = slideshow.slides || [];
        
        // Increment display count
        await fetch(`/api/slideshows/${slideshowId}/increment`, { method: 'POST' });
      }
    } else {
      // Load all active slideshows
      const response = await fetch('/api/slideshows/active');
      if (response.ok) {
        slideshows = await response.json();
        
        // Load slides for all slideshows
        for (const slideshow of slideshows) {
          const slidesResponse = await fetch(`/api/slideshows/${slideshow.id}`);
          if (slidesResponse.ok) {
            const data = await slidesResponse.json();
            allSlides.push(...(data.slides || []));
            
            // Increment display count
            await fetch(`/api/slideshows/${slideshow.id}/increment`, { method: 'POST' });
          }
        }
      }
    }
    
    // Sort slides by sort_order
    allSlides.sort((a, b) => a.sort_order - b.sort_order);
    
  } catch (error) {
    console.error('Failed to load slideshows:', error);
    showErrorMessage('Failed to load slideshows. Please refresh the page.');
  }
}

// Initialize slideshow
function initializeSlideshow() {
  if (allSlides.length === 0) {
    showErrorMessage('No slides available. Please add slides in the admin panel.');
    return;
  }
  
  renderSlides();
  createPagination();
  showSlide(0);
  startSlideshow();
}

function renderSlides() {
  const container = document.getElementById('slideshowContainer');
  container.innerHTML = '';
  
  allSlides.forEach((slide, index) => {
    const slideEl = document.createElement('div');
    slideEl.className = 'slide';
    slideEl.dataset.index = index;
    
    const imageSrc = slide.image_path || slide.image_url || '';
    
    slideEl.innerHTML = `
      <div class="slide-image-container">
        ${imageSrc ? `
          <img src="${imageSrc}" 
               alt="${escapeHtml(slide.title)}"
               class="slide-image"
               onerror="handleImageError(this)">
        ` : `
          <div class="placeholder-image">
            <div class="placeholder-text">No Image Available</div>
          </div>
        `}
      </div>
      <div class="slide-content" style="font-family: ${settings.font_family}">
        <div class="slide-title" style="font-size: ${settings.title_font_size}px">
          ${escapeHtml(slide.title)}
        </div>
        ${slide.description ? `
          <div class="slide-description" style="font-size: ${settings.description_font_size}px">
            ${escapeHtml(slide.description)}
          </div>
        ` : ''}
      </div>
    `;
    
    container.appendChild(slideEl);
  });
}

function createPagination() {
  const pagination = document.getElementById('pagination');
  pagination.innerHTML = '';
  
  allSlides.forEach((slide, index) => {
    const dot = document.createElement('div');
    dot.className = 'pagination-dot';
    dot.dataset.index = index;
    dot.addEventListener('click', () => {
      showSlide(index);
      restartSlideshow();
    });
    pagination.appendChild(dot);
  });
}

function showSlide(index) {
  if (index < 0) index = allSlides.length - 1;
  if (index >= allSlides.length) index = 0;
  
  currentSlideIndex = index;
  
  // Update slides
  document.querySelectorAll('.slide').forEach((slide, i) => {
    slide.classList.remove('active', 'prev');
    if (i === index) {
      slide.classList.add('active');
    } else if (i === index - 1 || (index === 0 && i === allSlides.length - 1)) {
      slide.classList.add('prev');
    }
  });
  
  // Update pagination
  document.querySelectorAll('.pagination-dot').forEach((dot, i) => {
    dot.classList.toggle('active', i === index);
  });
}

function nextSlide() {
  showSlide(currentSlideIndex + 1);
}

function prevSlide() {
  showSlide(currentSlideIndex - 1);
}

function startSlideshow() {
  if (slideshowInterval) {
    clearInterval(slideshowInterval);
  }
  
  const duration = parseInt(settings.transition_duration) || 5000;
  slideshowInterval = setInterval(nextSlide, duration);
}

function stopSlideshow() {
  if (slideshowInterval) {
    clearInterval(slideshowInterval);
    slideshowInterval = null;
  }
}

function togglePlayPause() {
  if (slideshowInterval) {
    stopSlideshow();
    document.getElementById('playPauseBtn').textContent = '▶️ Play';
  } else {
    startSlideshow();
    document.getElementById('playPauseBtn').textContent = '⏸️ Pause';
  }
}

function restartSlideshow() {
  stopSlideshow();
  startSlideshow();
}

// Event listeners
function setupEventListeners() {
  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    switch (e.key) {
      case 'ArrowLeft':
        prevSlide();
        restartSlideshow();
        break;
      case 'ArrowRight':
      case ' ':
        nextSlide();
        restartSlideshow();
        break;
      case 'Escape':
        if (document.fullscreenElement) {
          exitFullscreen();
        }
        break;
      case 'f':
      case 'F':
        toggleFullscreen();
        break;
    }
  });
  
  // Control buttons
  document.getElementById('playPauseBtn')?.addEventListener('click', togglePlayPause);
  document.getElementById('prevBtn')?.addEventListener('click', () => {
    prevSlide();
    restartSlideshow();
  });
  document.getElementById('nextBtn')?.addEventListener('click', () => {
    nextSlide();
    restartSlideshow();
  });
  document.getElementById('fullscreenBtn')?.addEventListener('click', toggleFullscreen);
  
  // Touch/swipe support
  let touchStartX = 0;
  let touchEndX = 0;
  
  document.addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].screenX;
  });
  
  document.addEventListener('touchend', (e) => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
  });
  
  function handleSwipe() {
    const swipeThreshold = 50;
    if (touchEndX < touchStartX - swipeThreshold) {
      nextSlide();
      restartSlideshow();
    }
    if (touchEndX > touchStartX + swipeThreshold) {
      prevSlide();
      restartSlideshow();
    }
  }
}

// Fullscreen functions
function requestFullscreen() {
  const elem = document.documentElement;
  if (elem.requestFullscreen) {
    elem.requestFullscreen().catch(err => {
      console.log('Fullscreen request failed:', err);
    });
  } else if (elem.webkitRequestFullscreen) {
    elem.webkitRequestFullscreen();
  } else if (elem.msRequestFullscreen) {
    elem.msRequestFullscreen();
  }
}

function exitFullscreen() {
  if (document.exitFullscreen) {
    document.exitFullscreen();
  } else if (document.webkitExitFullscreen) {
    document.webkitExitFullscreen();
  } else if (document.msExitFullscreen) {
    document.msExitFullscreen();
  }
}

function toggleFullscreen() {
  if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
    requestFullscreen();
  } else {
    exitFullscreen();
  }
}

// Error handling
function handleImageError(img) {
  const placeholder = document.createElement('div');
  placeholder.className = 'placeholder-image';
  placeholder.innerHTML = '<div class="placeholder-text">Image Not Found</div>';
  
  img.parentElement.replaceChild(placeholder, img);
  
  // Report error
  const slideId = img.closest('.slide').dataset.slideId;
  if (slideId) {
    fetch(`/api/slides/${slideId}/mark-not-loaded`, { method: 'POST' })
      .catch(err => console.error('Failed to mark slide as not loaded:', err));
  }
}

function showErrorMessage(message) {
  const container = document.getElementById('slideshowContainer');
  container.innerHTML = `
    <div class="slide active">
      <div class="placeholder-image">
        <div class="placeholder-text">${escapeHtml(message)}</div>
      </div>
    </div>
  `;
}

// Utility
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Auto-refresh every hour to get updated slides
setInterval(() => {
  window.location.reload();
}, 3600000); // 1 hour
