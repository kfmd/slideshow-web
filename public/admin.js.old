/* Admin Panel JavaScript */

let currentUser = null;
let currentView = 'dashboard';
let allSlideshows = [];
let allUsers = [];
let stats = null;
let settings = null;

// Initialize app
document.addEventListener('DOMContentLoaded', async () => {
  await checkAuth();
  await loadInitialData();
  setupEventListeners();
  showView('dashboard');
});

// Authentication
async function checkAuth() {
  try {
    const response = await fetch('/api/auth/me');
    if (!response.ok) {
      window.location.href = '/';
      return;
    }
    currentUser = await response.json();
    document.getElementById('username').textContent = currentUser.username;
    document.getElementById('userAvatar').textContent = currentUser.username.charAt(0).toUpperCase();
    
    // Hide admin-only elements for regular users
    if (currentUser.role !== 'admin') {
      document.querySelectorAll('[data-admin-only]').forEach(el => el.style.display = 'none');
    }
  } catch (error) {
    console.error('Auth check failed:', error);
    window.location.href = '/';
  }
}

async function logout() {
  try {
    await fetch('/api/auth/logout', { method: 'POST' });
    window.location.href = '/';
  } catch (error) {
    console.error('Logout failed:', error);
  }
}

// Data Loading
async function loadInitialData() {
  await Promise.all([
    loadStats(),
    loadSlideshows(),
    loadSettings(),
    currentUser.role === 'admin' ? loadUsers() : Promise.resolve()
  ]);
  updateNotifications();
}

async function loadStats() {
  try {
    const response = await fetch('/api/stats');
    stats = await response.json();
    renderStats();
  } catch (error) {
    console.error('Failed to load stats:', error);
  }
}

async function loadSlideshows() {
  try {
    const response = await fetch('/api/slideshows');
    allSlideshows = await response.json();
    renderSlideshows();
  } catch (error) {
    console.error('Failed to load slideshows:', error);
    showError('Failed to load slideshows');
  }
}

async function loadUsers() {
  try {
    const response = await fetch('/api/users');
    allUsers = await response.json();
    renderUsers();
  } catch (error) {
    console.error('Failed to load users:', error);
  }
}

async function loadSettings() {
  try {
    const response = await fetch('/api/settings');
    settings = await response.json();
    renderSettings();
  } catch (error) {
    console.error('Failed to load settings:', error);
  }
}

// Event Listeners
function setupEventListeners() {
  // Navigation
  document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', (e) => {
      const view = e.currentTarget.dataset.view;
      showView(view);
    });
  });

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', logout);

  // Slideshow actions
  document.getElementById('createSlideshowBtn')?.addEventListener('click', openCreateSlideshowModal);
  
  // Mobile menu toggle
  document.getElementById('mobileMenuToggle')?.addEventListener('click', toggleMobileMenu);
}

function toggleMobileMenu() {
  document.querySelector('.sidebar').classList.toggle('active');
}

// View Management
function showView(viewName) {
  currentView = viewName;
  
  // Update navigation
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
    if (item.dataset.view === viewName) {
      item.classList.add('active');
    }
  });

  // Hide all views
  document.querySelectorAll('[data-view]').forEach(view => {
    view.style.display = 'none';
  });

  // Show selected view
  const selectedView = document.querySelector(`[data-view="${viewName}"]`);
  if (selectedView) {
    selectedView.style.display = 'block';
    
    // Update header title
    const titles = {
      dashboard: 'Dashboard',
      slideshows: 'Slideshows',
      users: 'User Management',
      settings: 'Settings',
      stats: 'Statistics'
    };
    document.querySelector('.header-title').textContent = titles[viewName] || viewName;
  }
}

// Render Functions
function renderStats() {
  if (!stats) return;

  document.getElementById('totalSlideshows').textContent = stats.total_slideshows || 0;
  document.getElementById('activeSlideshows').textContent = stats.active_slideshows || 0;
  document.getElementById('totalDisplays').textContent = stats.total_displays || 0;
  document.getElementById('totalSlides').textContent = stats.total_slides || 0;
}

function renderSlideshows() {
  const container = document.getElementById('slideshowsGrid');
  
  if (allSlideshows.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üìä</div>
        <div class="empty-state-title">No Slideshows Yet</div>
        <div class="empty-state-text">Create your first slideshow to get started</div>
        <button class="btn btn-primary" onclick="openCreateSlideshowModal()">Create Slideshow</button>
      </div>
    `;
    return;
  }

  container.innerHTML = allSlideshows.map(slideshow => `
    <div class="slideshow-card">
      <div class="slideshow-info">
        <div class="slideshow-title">${escapeHtml(slideshow.title)}</div>
        <div class="slideshow-description">${escapeHtml(slideshow.description || '')}</div>
        <div class="slideshow-meta">
          <span class="badge ${slideshow.status === 'active' ? 'badge-success' : 'badge-danger'}">
            ${slideshow.status}
          </span>
          <span>Displays: ${slideshow.display_count || 0}</span>
        </div>
        <div class="slideshow-actions">
          <button class="btn btn-sm btn-primary" onclick="manageslides('${slideshow.id}')">
            Manage Slides
          </button>
          <button class="btn btn-sm btn-outline" onclick="previewSlideshow('${slideshow.id}')">
            Preview
          </button>
          <button class="btn btn-sm btn-secondary" onclick="editSlideshow('${slideshow.id}')">
            Edit
          </button>
          <button class="btn btn-sm btn-danger" onclick="deleteSlideshow('${slideshow.id}')">
            Delete
          </button>
        </div>
      </div>
    </div>
  `).join('');
}

function renderUsers() {
  const container = document.getElementById('usersTable');
  
  if (!allUsers || allUsers.length === 0) {
    container.innerHTML = '<tr><td colspan="4" class="text-center">No users found</td></tr>';
    return;
  }

  container.innerHTML = allUsers.map(user => `
    <tr>
      <td>${escapeHtml(user.username)}</td>
      <td><span class="badge ${user.role === 'admin' ? 'badge-warning' : 'badge-info'}">${user.role}</span></td>
      <td>${new Date(user.created_at * 1000).toLocaleDateString()}</td>
      <td>
        <button class="btn btn-sm btn-secondary" onclick="changePassword('${user.id}')">
          Change Password
        </button>
        ${user.id !== currentUser.id ? `
          <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')">
            Delete
          </button>
        ` : ''}
      </td>
    </tr>
  `).join('');
}

function renderSettings() {
  if (!settings) return;

  document.getElementById('fontFamily').value = settings.font_family || 'Arial, sans-serif';
  document.getElementById('titleFontSize').value = settings.title_font_size || '48';
  document.getElementById('descriptionFontSize').value = settings.description_font_size || '24';
  document.getElementById('transitionDuration').value = settings.transition_duration || '5000';
  
  if (settings.company_logo) {
    document.getElementById('currentLogo').src = settings.company_logo;
    document.getElementById('currentLogo').style.display = 'block';
  }
}

// Slideshow Functions
function openCreateSlideshowModal() {
  const modal = document.getElementById('slideshowModal');
  document.getElementById('slideshowForm').reset();
  document.getElementById('slideshowModalTitle').textContent = 'Create New Slideshow';
  document.getElementById('slideshowId').value = '';
  modal.classList.add('active');
}

async function editSlideshow(id) {
  const slideshow = allSlideshows.find(s => s.id === id);
  if (!slideshow) return;

  document.getElementById('slideshowModalTitle').textContent = 'Edit Slideshow';
  document.getElementById('slideshowId').value = id;
  document.getElementById('slideshowTitle').value = slideshow.title;
  document.getElementById('slideshowDescription').value = slideshow.description || '';
  document.getElementById('slideshowStatus').value = slideshow.status;
  
  document.getElementById('slideshowModal').classList.add('active');
}

async function saveSlideshow(event) {
  event.preventDefault();
  
  const id = document.getElementById('slideshowId').value;
  const title = document.getElementById('slideshowTitle').value;
  const description = document.getElementById('slideshowDescription').value;
  const status = document.getElementById('slideshowStatus').value;

  try {
    const url = id ? `/api/slideshows/${id}` : '/api/slideshows';
    const method = id ? 'PUT' : 'POST';

    const response = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, description, status })
    });

    if (response.ok) {
      closeModal('slideshowModal');
      await loadSlideshows();
      await loadStats();
      showSuccess(id ? 'Slideshow updated successfully' : 'Slideshow created successfully');
    } else {
      const error = await response.json();
      showError(error.error || 'Failed to save slideshow');
    }
  } catch (error) {
    console.error('Save slideshow error:', error);
    showError('Failed to save slideshow');
  }
}

async function deleteSlideshow(id) {
  if (!confirm('Are you sure you want to delete this slideshow? All slides will be deleted.')) {
    return;
  }

  try {
    const response = await fetch(`/api/slideshows/${id}`, { method: 'DELETE' });
    
    if (response.ok) {
      await loadSlideshows();
      await loadStats();
      showSuccess('Slideshow deleted successfully');
    } else {
      showError('Failed to delete slideshow');
    }
  } catch (error) {
    console.error('Delete slideshow error:', error);
    showError('Failed to delete slideshow');
  }
}

async function manageSlides(slideshowId) {
  currentSlideshowId = slideshowId;
  const slideshow = allSlideshows.find(s => s.id === slideshowId);
  
  if (!slideshow) return;

  document.getElementById('slideManagementTitle').textContent = `Manage Slides: ${slideshow.title}`;
  
  await loadSlides(slideshowId);
  
  document.getElementById('slideManagementModal').classList.add('active');
}

let currentSlides = [];
let currentSlideshowId = null;

async function loadSlides(slideshowId) {
  try {
    const response = await fetch(`/api/slideshows/${slideshowId}`);
    const data = await response.json();
    currentSlides = data.slides || [];
    renderSlides();
  } catch (error) {
    console.error('Failed to load slides:', error);
  }
}

function renderSlides() {
  const container = document.getElementById('slidesList');
  
  if (currentSlides.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üñºÔ∏è</div>
        <div class="empty-state-title">No Slides Yet</div>
        <div class="empty-state-text">Add slides to this slideshow</div>
      </div>
    `;
    return;
  }

  container.innerHTML = currentSlides.map((slide, index) => `
    <div class="slide-item">
      <img src="${slide.image_path || slide.image_url || '/placeholder.png'}" 
           alt="${escapeHtml(slide.title)}"
           class="slide-preview"
           onerror="this.src='/placeholder.png'">
      <div class="slide-content">
        <div class="slide-title">${escapeHtml(slide.title)}</div>
        <div class="slide-description">${escapeHtml(slide.description || '')}</div>
      </div>
      <div class="slide-actions">
        <button class="btn btn-sm btn-danger" onclick="deleteSlide('${slide.id}')">
          Delete
        </button>
      </div>
    </div>
  `).join('');
}

async function deleteSlide(slideId) {
  if (!confirm('Are you sure you want to delete this slide?')) {
    return;
  }

  try {
    const response = await fetch(`/api/slides/${slideId}`, { method: 'DELETE' });
    
    if (response.ok) {
      await loadSlides(currentSlideshowId);
      await loadStats();
      showSuccess('Slide deleted successfully');
    } else {
      showError('Failed to delete slide');
    }
  } catch (error) {
    console.error('Delete slide error:', error);
    showError('Failed to delete slide');
  }
}

function openAddSlidesModal() {
  document.getElementById('addSlidesModal').classList.add('active');
}

async function uploadSlides(event) {
  event.preventDefault();
  
  const formData = new FormData();
  const files = document.getElementById('slideImages').files;
  const title = document.getElementById('slideTitle').value;
  const description = document.getElementById('slideDescription').value;

  if (files.length === 0) {
    showError('Please select at least one image');
    return;
  }

  formData.append('slideshow_id', currentSlideshowId);
  
  for (let i = 0; i < files.length; i++) {
    formData.append('images', files[i]);
    formData.append('titles', title || `Slide ${i + 1}`);
    formData.append('descriptions', description || '');
  }

  try {
    const response = await fetch('/api/slides', {
      method: 'POST',
      body: formData
    });

    if (response.ok) {
      closeModal('addSlidesModal');
      await loadSlides(currentSlideshowId);
      await loadStats();
      document.getElementById('addSlidesForm').reset();
      showSuccess('Slides uploaded successfully');
    } else {
      const error = await response.json();
      showError(error.error || 'Failed to upload slides');
    }
  } catch (error) {
    console.error('Upload slides error:', error);
    showError('Failed to upload slides');
  }
}

async function previewSlideshow(slideshowId) {
  window.open(`/slideshow?id=${slideshowId}`, '_blank');
}

// User Management
function openAddUserModal() {
  document.getElementById('addUserModal').classList.add('active');
  document.getElementById('addUserForm').reset();
}

async function createUser(event) {
  event.preventDefault();
  
  const username = document.getElementById('newUsername').value;
  const password = document.getElementById('newPassword').value;
  const role = document.getElementById('newUserRole').value;

  try {
    const response = await fetch('/api/users', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password, role })
    });

    if (response.ok) {
      closeModal('addUserModal');
      await loadUsers();
      document.getElementById('addUserForm').reset();
      showSuccess('User created successfully');
    } else {
      const error = await response.json();
      showError(error.error || 'Failed to create user');
    }
  } catch (error) {
    console.error('Create user error:', error);
    showError('Failed to create user');
  }
}

async function changePassword(userId) {
  const newPassword = prompt('Enter new password:');
  if (!newPassword) return;

  try {
    const response = await fetch(`/api/users/${userId}/password`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ newPassword })
    });

    if (response.ok) {
      showSuccess('Password updated successfully');
    } else {
      const error = await response.json();
      showError(error.error || 'Failed to update password');
    }
  } catch (error) {
    console.error('Change password error:', error);
    showError('Failed to update password');
  }
}

async function deleteUser(userId) {
  if (!confirm('Are you sure you want to delete this user?')) {
    return;
  }

  try {
    const response = await fetch(`/api/users/${userId}`, { method: 'DELETE' });
    
    if (response.ok) {
      await loadUsers();
      showSuccess('User deleted successfully');
    } else {
      showError('Failed to delete user');
    }
  } catch (error) {
    console.error('Delete user error:', error);
    showError('Failed to delete user');
  }
}

// Settings
async function saveSettings(event) {
  event.preventDefault();
  
  const settingsData = {
    font_family: document.getElementById('fontFamily').value,
    title_font_size: document.getElementById('titleFontSize').value,
    description_font_size: document.getElementById('descriptionFontSize').value,
    transition_duration: document.getElementById('transitionDuration').value
  };

  try {
    const response = await fetch('/api/settings', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(settingsData)
    });

    if (response.ok) {
      await loadSettings();
      showSuccess('Settings updated successfully');
    } else {
      showError('Failed to update settings');
    }
  } catch (error) {
    console.error('Save settings error:', error);
    showError('Failed to update settings');
  }
}

async function uploadLogo(event) {
  const file = event.target.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append('logo', file);

  try {
    const response = await fetch('/api/settings/logo', {
      method: 'POST',
      body: formData
    });

    if (response.ok) {
      const data = await response.json();
      document.getElementById('currentLogo').src = data.path;
      document.getElementById('currentLogo').style.display = 'block';
      showSuccess('Logo uploaded successfully');
    } else {
      showError('Failed to upload logo');
    }
  } catch (error) {
    console.error('Upload logo error:', error);
    showError('Failed to upload logo');
  }
}

// Notifications
function updateNotifications() {
  if (!stats) return;
  
  const notLoadedCount = stats.not_loaded_count || 0;
  const badge = document.querySelector('.notification-badge');
  
  if (badge) {
    badge.setAttribute('data-count', notLoadedCount);
  }
}

// Utility Functions
function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('active');
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function showSuccess(message) {
  showNotification(message, 'success');
}

function showError(message) {
  showNotification(message, 'error');
}

function showNotification(message, type) {
  const notification = document.createElement('div');
  notification.className = `alert alert-${type}`;
  notification.textContent = message;
  notification.style.position = 'fixed';
  notification.style.top = '20px';
  notification.style.right = '20px';
  notification.style.zIndex = '10000';
  notification.style.minWidth = '300px';
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 3000);
}

// Modal close handlers
document.querySelectorAll('.modal-close').forEach(btn => {
  btn.addEventListener('click', function() {
    this.closest('.modal').classList.remove('active');
  });
});

// Click outside modal to close
document.querySelectorAll('.modal').forEach(modal => {
  modal.addEventListener('click', function(e) {
    if (e.target === this) {
      this.classList.remove('active');
    }
  });
});
